<html>
<head>
  <meta charset="utf-8">
  <title>Hello Pixi</title>
</head>
<script src="jointjs/dagre.min.js"></script>
<script src="jointjs/graphlib.min.js"></script>
<script src="jointjs/jquery.min.js"></script>
<script src="jointjs/lodash.min.js"></script>
<script src="jointjs/backbone.js"></script>
<script src="jointjs/joint-3.0.2.min.js"></script>
<script src="py_trees.js"></script>
<link rel="stylesheet" type="text/css" href="jointjs/joint-3.0.2.min.css"/>
<style>
  body {
    margin: 0;
  }
</style>
<body>
  <div id="foo"></div>
  <script type="text/javascript">
    // Hello to the JS console
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
    PIXI.utils.sayHello(type)
    console.log("JointJS: %s", joint.version)
  </script>
  <div id="myholder"></div>
  <script type="text/javascript">
    // Additionally, the graph accepts an option object in its constructor function that can contain the cellNamespace option.
    //
    // This option can be used to change the default behavior of JointJS which by default reads cell model definitions
    // from the joint.shapes namespace. For example, if a cell is of type 'myshapes.MyElement', then the graph looks up
    // joint.shapes.myshapes.MyElement model when deserializing a graph from the JSON format. If the graph is instantiated as
    // e.g. var graph = new joint.dia.Graph({}, { cellNamespace: myShapesNamespace }), then the graph will read the model
    // definition from the myShapesNamespace.myshapes.MyElement object instead.
    //
    // This is useful in situations where you don't want to - for any reason -
    // use the joint.shapes namespace for defining your own custom shapes. This option is often used in combination with the
    // cellNamespaceView option on the joint.dia.Paper object.
    var graph = new joint.dia.Graph({
      cellNamespace: py_trees.shapes
    });

    var paper = new joint.dia.Paper({
      el: document.getElementById('myholder'),
      model: graph,
      width: '100%',
      height: '100%',
      cellViewNamespace: py_trees.shapes,
      // defaultConnector: {  // doesn't seem to have any effect
      //     name: 'rounded',
      //     args: {
      //         radius: 20
      //     }
      // },
      background: { color: '#111111' },
      // gridSize: 15,     // doesn't work?
      // drawGrid: {
      //     name: 'doubleMesh',
      //     args: [
      //         { color: '#222222', thickness: 1 }, // settings for the primary mesh
      //         { color: '#333333', scaleFactor: 5, thickness: 5 } //settings for the secondary mesh
      // ]}
    });
    
    tree = {
        nodes: {
            '1': {
                id: '1',
                status: 'INVALID',
                name: 'Selector',
                colour: '#00FFFF',
                children: ['2', '3', '4', '6'],
                data: {
                    type: 'py_trees.composites.Selector',
                    feedback: "Decision maker",
                },
            },
            '2': {
                id: '2',
                status: 'INVALID',
                name: 'Sequence',
                colour: '#FFA500',
                data: {
                    type: 'py_trees.composites.Sequence',
                    feedback: "Worker"
                },
            },
            '3': {
                id: '3',
                status: 'INVALID',
                name: 'Parallel',
                colour: '#FFFF00',
                data: {
                    type: 'py_trees.composites.Parallel',
                    feedback: 'Bob is da best ....',
                },
            },
            '4': {
                id: '4',
                status: 'INVALID',
                name: 'Decorator',
                colour: '#DDDDDD',
                data: {
                    type: 'py_trees.composites.Decorator',
                    feedback: 'Wearing the hats',
                },
            },
            '5': {
                id: '5',
                status: 'INVALID',
                name: 'Decorated',
                colour: '#555555',
                data: {
                    type: 'py_trees.composites.Behaviour',
                    feedback: "...."
                },
            },
            '6': {
                id: '6',
                status: 'INVALID',
                name: 'Behaviour',
                colour: '#555555',
                data: {
                    type: 'py_trees.composites.Behaviour',
                    feedback: "..."
                },
            },
        }
    }
    

    root_children = {}

    root_children.selector = new py_trees.shapes.create_selector({
      details: "decision maker"
    })

    root_children.sequence = new py_trees.shapes.create_sequence({
      details: "Worker"
    })

    root_children.parallel = new py_trees.shapes.create_parallel({
      details: "Bob is da best of all time, forever"
    })

    root_children.decorator = new py_trees.shapes.create_decorator({
        details: "Wearing hats"
    })

    root_children.behaviour = new py_trees.shapes.create_behaviour({
        details: "I'm the pleb"
    })

    decorated = new py_trees.shapes.create_behaviour({
        name: "Decorated",
        details: "..."
    })
    console.log("Decorated")
    console.log(decorated)
    console.log(root_children)
    for (child in root_children) {
      console.log("Child: " + root_children[child].attributes.attrs.name.text)
      console.log(root_children[child])
      console.log(root_children[child])
      root_children[child].addTo(graph)
      py_trees.shapes.create_link({source: root_children.selector, target: root_children[child]})
    }
    decorated.addTo(graph)
    py_trees.shapes.create_link({source: root_children.decorator, target: decorated})

    // py_trees.experiments.create_tabbed_tree({graph})
    // paper.scale(0.5, 0.5); // the api to enable zooming

    var graph_bounding_box = joint.layout.DirectedGraph.layout(graph, {
        marginX: 50,
        marginY: 50,
        nodeSep: 50,
        edgeSep: 80,
        rankDir: "TB"
    });
    console.log("Bounding Box")
    console.log('  x:', graph_bounding_box.x, 'y:', graph_bounding_box.y)
    console.log('  width:', graph_bounding_box.width, 'height:', graph_bounding_box.height);
  </script>
</body>
</html>
